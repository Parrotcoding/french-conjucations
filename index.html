<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÃŠtre Speedrun â€“ Pronouns + Conjugations</title>
  <style>
    :root{
      --bg:#070b14;
      --text:#eef2ff;
      --muted:#a9b4d0;
      --good:#34d399;
      --bad:#fb7185;
      --accent:#60a5fa;
      --shadow: 0 24px 80px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(96,165,250,.22), transparent 60%),
        radial-gradient(900px 700px at 80% 30%, rgba(192,132,252,.18), transparent 55%),
        radial-gradient(700px 600px at 35% 85%, rgba(52,211,153,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      overflow:hidden;
    }
    .topbar{
      position:fixed;
      top:14px; left:14px; right:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      z-index:10;
      pointer-events:none;
    }
    .pill{
      pointer-events:auto;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.28);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      font-weight:900;
      font-size:13px;
    }
    .pill span{color:var(--muted)}
    .btn{
      pointer-events:auto;
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(180deg, rgba(96,165,250,.28), rgba(96,165,250,.12));
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:1000;
      font-size:13px;
      transition: transform .08s ease, filter .2s ease, opacity .2s ease;
      user-select:none;
    }
    .btn.secondary{background:rgba(255,255,255,.08)}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    .screen{
      height:100%;
      width:100%;
      display:none;
      align-items:center;
      justify-content:center;
      padding:84px 22px 22px;
    }
    .screen.active{display:flex}

    .card{
      width:min(980px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.14);
      border-radius:28px;
      box-shadow:var(--shadow);
      padding:22px;
    }
    h1{margin:0 0 8px; font-size:22px}
    .sub{margin:0 0 18px; color:var(--muted); line-height:1.4}
    .divider{height:1px; background:rgba(255,255,255,.12); margin:16px 0}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center}
    .fine{font-size:12px;color:var(--muted);line-height:1.35}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    /* Matching */
    .matchWrap{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      width:100%;
      margin-top:10px;
    }
    .col{
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:20px;
      padding:14px;
      min-height:360px;
    }
    .colTitle{
      margin:0 0 10px;
      color:var(--muted);
      font-size:12px;
      font-weight:1000;
      letter-spacing:.5px;
      text-transform:uppercase;
    }
    .list{display:flex; flex-direction:column; gap:10px}
    .tile{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight:1000;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .tile:hover{background:rgba(255,255,255,.08)}
    .tile:active{transform:translateY(1px)}
    .tile .chip{
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      white-space:nowrap;
    }
    .tile.selected{
      border-color:rgba(96,165,250,.75);
      background:rgba(96,165,250,.14);
    }
    .tile.locked{
      cursor:default;
      border-color:rgba(52,211,153,.55);
      background:rgba(52,211,153,.10);
    }
    .tile.bad{
      border-color:rgba(251,113,133,.7);
      background:rgba(251,113,133,.10);
    }

    /* Scenarios */
    .scenarioBox{
      width:min(720px, 100%);
      margin:0 auto;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:24px;
      padding:18px;
      text-align:center;
    }
    .qTop{display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-bottom:10px}
    .qPill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-weight:1000;
      font-size:13px;
    }
    .prompt{
      font-size:22px;
      font-weight:1000;
      margin:8px 0 12px;
    }
    .accentBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(255,255,255,.04);
      padding:10px;
      border-radius:16px;
      margin:10px 0 12px;
    }
    .keyBtn{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:999px;
      padding:7px 10px;
      cursor:pointer;
      font-weight:1000;
      font-size:12px;
    }
    .keyBtn kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:11px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      margin-right:6px;
    }
    .answerRow{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:stretch;
      flex-wrap:wrap;
      margin-top:10px;
    }
    input[type="text"]{
      width:min(520px, 100%);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:14px 14px;
      font-size:18px;
      font-weight:900;
      outline:none;
      text-align:center;
    }
    input[type="text"]:focus{
      border-color:rgba(96,165,250,.65);
      box-shadow:0 0 0 4px rgba(96,165,250,.18);
    }
    .status{
      margin-top:12px;
      font-weight:1000;
      border-radius:16px;
      padding:12px 14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:var(--muted);
    }
    .status.good{border-color:rgba(52,211,153,.55); background:rgba(52,211,153,.10); color:rgba(232,255,244,.92)}
    .status.bad{border-color:rgba(251,113,133,.6); background:rgba(251,113,133,.10); color:rgba(255,236,240,.92)}

    /* Leaderboard */
    .scoresWrap{
      width:min(860px, 100%);
      margin:0 auto;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:24px;
      padding:18px;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.12);
      margin-top:10px;
    }
    th, td{
      text-align:left;
      padding:10px 10px;
      font-size:13px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    th{color:var(--muted); font-weight:1000; font-size:12px; text-transform:uppercase; letter-spacing:.4px}
    tr:last-child td{border-bottom:none}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="pill"><span>Time</span> <strong id="timeText">â€”</strong></div>
    <div class="row" style="pointer-events:none">
      <button class="btn secondary" id="viewBoardBtn" style="pointer-events:auto">Leaderboard</button>
      <button class="btn secondary" id="resetBtn" style="pointer-events:auto" disabled>Reset</button>
    </div>
  </div>

  <section class="screen active" id="startScreen">
    <div class="card">
      <h1>ÃŠtre Speedrun</h1>
      <p class="sub">Stage 1: match pronouns â†’ conjugations. Stage 2: 10 scenarios. Timer runs from Start to final correct answer.</p>
      <div class="row">
        <button class="btn" id="startBtn">Start</button>
      </div>
      <div class="divider"></div>
    </div>
  </section>

  <section class="screen" id="matchScreen">
    <div class="card">
      <h1>Stage 1 â€” Matching</h1>
      <p class="sub">
        Click a pronoun, then click its conjugation. For duplicates like <strong>est</strong> and <strong>sont</strong>,
        <strong>any</strong> matching tile works.
      </p>

      <div class="matchWrap">
        <div class="col">
          <p class="colTitle">Pronouns</p>
          <div class="list" id="pronounList"></div>
        </div>
        <div class="col">
          <p class="colTitle">Conjugations</p>
          <div class="list" id="conjList"></div>
        </div>
      </div>

      <div class="divider"></div>
      <p class="fine" id="matchStatus">Match all pairs to continue.</p>
    </div>
  </section>

  <section class="screen" id="scenarioScreen">
    <div class="card">
      <h1>Stage 2 â€” Scenarios</h1>
      <p class="sub">Type the correct French answer. Case-insensitive. Spaces are flexible. Redos required until correct.</p>

      <div class="scenarioBox">
        <div class="qTop">
          <div class="qPill" id="qProgress">Question â€” / 10</div>
          <div class="qPill">Tip: press <strong>1</strong> for <strong>Ãª</strong></div>
        </div>

        <div class="prompt" id="promptText">â€”</div>

        <div class="accentBar">
          <div class="fine">Accent keys:</div>
          <button class="keyBtn" id="key1"><kbd>1</kbd> Ãª</button>
        </div>

        <div class="answerRow">
          <input id="answerInput" type="text" autocomplete="off" placeholder="Type (e.g., Il est)" />
          <button class="btn" id="checkBtn">Check</button>
        </div>

        <div class="status" id="statusBox">Type your answer to continue.</div>
      </div>
    </div>
  </section>

  <section class="screen" id="boardScreen">
    <div class="card">
      <h1 id="boardTitle">Leaderboard</h1>
      <p class="sub" id="boardSubtitle">Top 10 fastest times.</p>

      <div class="scoresWrap">
        <div class="row" style="justify-content:space-between; align-items:flex-end">
          <div style="text-align:left">
            <div class="fine" id="finalTimeText"></div>
            <div class="fine">Save your score:</div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <input id="nameInput" type="text" maxlength="24" placeholder="Name" style="width:220px; text-align:left" />
            <button class="btn" id="saveBtn">Save</button>
          </div>
        </div>

        <div class="status" id="saveStatus" style="margin-top:12px">Loadingâ€¦</div>

        <table id="scoreTable" style="display:none">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Time</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="scoreBody"></tbody>
        </table>

        <div class="divider"></div>
        <div class="row">
          <button class="btn secondary" id="backToStartBtn">Back to Start</button>
          <button class="btn" id="playAgainBtn">Play Again</button>
        </div>

        <p class="fine" style="margin-top:12px">API: <code id="apiLabel2"></code></p>
      </div>
    </div>
  </section>

<script>
/* CONFIG */
const HIGHSCORE_URL = "https://pronounfrenchleaderboard.orcajoon.workers.dev/api/highscores";

/* MATCHING DATA
   We intentionally allow ANY matching tile for duplicates.
*/
const MATCH_TARGETS = [
  { pronoun: "Je",    target: "suis"   },
  { pronoun: "Tu",    target: "es"     },
  { pronoun: "Il",    target: "est"    },
  { pronoun: "Elle",  target: "est"    },
  { pronoun: "On",    target: "est"    },
  { pronoun: "Nous",  target: "sommes" },
  { pronoun: "Vous",  target: "Ãªtes"   },
  { pronoun: "Ils",   target: "sont"   },
  { pronoun: "Elles", target: "sont"   }
];

const SCENARIO_KEYS = ["je","tu","il","elle","on","nous","vous","ils","ils","elles"];

const NAMES_MALE = ["Pierre","Louis","Hugo","Noah","Lucas","Arthur","Jules","Paul","Maxime","ThÃ©o","Antoine","Nicolas"];
const NAMES_FEMALE = ["Marie","Camille","ChloÃ©","Emma","LÃ©a","Sophie","Manon","Sarah","Julie","InÃ¨s","AnaÃ¯s","Clara"];
const NAMES_GROUP_MIXED = ["Pierre & Marie", "Louis & ChloÃ©", "Hugo & Emma", "Jules & LÃ©a", "Arthur & Sophie"];
const NAMES_GROUP_FEMALE = ["Marie & Camille", "ChloÃ© & LÃ©a", "Emma & Sarah", "Julie & Clara", "InÃ¨s & AnaÃ¯s"];

/* DOM */
const timeText = document.getElementById("timeText");
const resetBtn = document.getElementById("resetBtn");
const startBtn = document.getElementById("startBtn");
const viewBoardBtn = document.getElementById("viewBoardBtn");

const startScreen = document.getElementById("startScreen");
const matchScreen = document.getElementById("matchScreen");
const scenarioScreen = document.getElementById("scenarioScreen");
const boardScreen = document.getElementById("boardScreen");

const pronounList = document.getElementById("pronounList");
const conjList = document.getElementById("conjList");
const matchStatus = document.getElementById("matchStatus");

const qProgress = document.getElementById("qProgress");
const promptText = document.getElementById("promptText");
const answerInput = document.getElementById("answerInput");
const checkBtn = document.getElementById("checkBtn");
const statusBox = document.getElementById("statusBox");
const key1 = document.getElementById("key1");

const apiLabel = document.getElementById("apiLabel");
const apiLabel2 = document.getElementById("apiLabel2");

const boardTitle = document.getElementById("boardTitle");
const boardSubtitle = document.getElementById("boardSubtitle");
const finalTimeText = document.getElementById("finalTimeText");
const nameInput = document.getElementById("nameInput");
const saveBtn = document.getElementById("saveBtn");
const saveStatus = document.getElementById("saveStatus");
const scoreTable = document.getElementById("scoreTable");
const scoreBody = document.getElementById("scoreBody");
const backToStartBtn = document.getElementById("backToStartBtn");
const playAgainBtn = document.getElementById("playAgainBtn");

/* HELPERS */
function show(screen){
  [startScreen, matchScreen, scenarioScreen, boardScreen].forEach(s=>s.classList.remove("active"));
  screen.classList.add("active");
}
function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function formatTime(ms){
  const total = Math.max(0, Math.floor(ms));
  const sec = Math.floor(total/1000);
  const m = Math.floor(sec/60);
  const s = sec % 60;
  const cs = Math.floor((total % 1000)/10);
  return `${m}:${String(s).padStart(2,"0")}.${String(cs).padStart(2,"0")}`;
}
function normalize(s){
  return (s||"").trim().replace(/\s+/g," ").toLowerCase();
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}
function insertAtCursor(input, text){
  const start = input.selectionStart ?? input.value.length;
  const end = input.selectionEnd ?? input.value.length;
  const before = input.value.slice(0, start);
  const after  = input.value.slice(end);
  input.value = before + text + after;
  const pos = start + text.length;
  input.setSelectionRange(pos, pos);
  input.focus();
}

/* TIMER */
let started = false;
let startMs = 0;
let timerHandle = null;
function startTimer(){
  startMs = performance.now();
  timeText.textContent = "0:00.00";
  timerHandle = setInterval(()=>{ timeText.textContent = formatTime(performance.now() - startMs); }, 50);
}
function stopTimer(){ if (timerHandle) clearInterval(timerHandle); timerHandle = null; }
function elapsedMs(){ return Math.floor(performance.now() - startMs); }

/* STAGE 1 MATCHING (pool-based for duplicates) */
let selectedPronounEl = null; // el
let selectedConjEl = null;    // el
let matchedCount = 0;

function buildMatchingUI(){
  pronounList.innerHTML = "";
  conjList.innerHTML = "";
  selectedPronounEl = null;
  selectedConjEl = null;
  matchedCount = 0;

  // build pronoun tiles
  const pronouns = shuffle(MATCH_TARGETS.map(x => ({ pronoun:x.pronoun, target:x.target })));
  pronouns.forEach(item=>{
    const el = document.createElement("div");
    el.className = "tile";
    el.dataset.target = item.target;     // what it needs
    el.dataset.locked = "0";
    el.innerHTML = `<div>${item.pronoun}</div><span class="chip">click</span>`;
    el.addEventListener("click", ()=>onPronounClick(el));
    pronounList.appendChild(el);
  });

  // build conjugation tiles (including duplicates)
  const conjs = shuffle(MATCH_TARGETS.map(x => x.target));
  conjs.forEach(target=>{
    const el = document.createElement("div");
    el.className = "tile";
    el.dataset.value = target; // what it is
    el.dataset.locked = "0";
    el.innerHTML = `<div>${target}</div><span class="chip">click</span>`;
    el.addEventListener("click", ()=>onConjClick(el));
    conjList.appendChild(el);
  });

  matchStatus.textContent = `Matched 0 / ${MATCH_TARGETS.length}`;
}

function clearBad(){
  document.querySelectorAll(".tile.bad").forEach(el=>el.classList.remove("bad"));
}

function onPronounClick(el){
  if (el.dataset.locked === "1") return;
  clearBad();
  document.querySelectorAll("#pronounList .tile.selected").forEach(t=>t.classList.remove("selected"));
  el.classList.add("selected");
  selectedPronounEl = el;
  tryMatch();
}

function onConjClick(el){
  if (el.dataset.locked === "1") return;
  clearBad();
  document.querySelectorAll("#conjList .tile.selected").forEach(t=>t.classList.remove("selected"));
  el.classList.add("selected");
  selectedConjEl = el;
  tryMatch();
}

function tryMatch(){
  if (!selectedPronounEl || !selectedConjEl) return;

  const need = selectedPronounEl.dataset.target;
  const got = selectedConjEl.dataset.value;
  const ok = (need === got);

  if (ok){
    // lock both tiles
    selectedPronounEl.dataset.locked = "1";
    selectedConjEl.dataset.locked = "1";
    selectedPronounEl.classList.remove("selected");
    selectedConjEl.classList.remove("selected");
    selectedPronounEl.classList.add("locked");
    selectedConjEl.classList.add("locked");
    selectedPronounEl.querySelector(".chip").textContent = "âœ“";
    selectedConjEl.querySelector(".chip").textContent = "âœ“";
    matchedCount++;
    matchStatus.textContent = `Matched ${matchedCount} / ${MATCH_TARGETS.length}`;
    selectedPronounEl = null;
    selectedConjEl = null;

    if (matchedCount === MATCH_TARGETS.length){
      matchStatus.textContent = "Nice â€” moving to scenariosâ€¦";
      setTimeout(startScenarios, 350);
    }
  } else {
    selectedPronounEl.classList.add("bad");
    selectedConjEl.classList.add("bad");
    selectedPronounEl.classList.remove("selected");
    selectedConjEl.classList.remove("selected");
    const p = selectedPronounEl, c = selectedConjEl;
    selectedPronounEl = null;
    selectedConjEl = null;
    setTimeout(()=>{ p.classList.remove("bad"); c.classList.remove("bad"); }, 450);
  }
}

/* STAGE 2 SCENARIOS */
function expectedFor(key){
  if (key==="je") return "Je suis";
  if (key==="tu") return "Tu es";
  if (key==="il") return "Il est";
  if (key==="elle") return "Elle est";
  if (key==="on") return "On est";
  if (key==="nous") return "Nous sommes";
  if (key==="vous") return "Vous Ãªtes";
  if (key==="ils") return "Ils sont";
  if (key==="elles") return "Elles sont";
  return "";
}
function promptFor(key){
  if (key==="je") return `I am â€¦`;
  if (key==="tu") return `You are (informal) â€¦`;
  if (key==="vous") return `You are (formal) â€¦`;
  if (key==="nous") return `We are â€¦`;
  if (key==="on") return `One is / People are â€¦`;
  if (key==="il") return `${NAMES_MALE[Math.floor(Math.random()*NAMES_MALE.length)]} is â€¦`;
  if (key==="elle") return `${NAMES_FEMALE[Math.floor(Math.random()*NAMES_FEMALE.length)]} is â€¦`;
  if (key==="ils") return `${NAMES_GROUP_MIXED[Math.floor(Math.random()*NAMES_GROUP_MIXED.length)]} are â€¦`;
  if (key==="elles") return `${NAMES_GROUP_FEMALE[Math.floor(Math.random()*NAMES_GROUP_FEMALE.length)]} are â€¦`;
  return "â€”";
}

let questions = [];
let qIndex = 0;

function buildQuestions(){
  const keys = shuffle(SCENARIO_KEYS);
  questions = keys.map(k => ({ key:k, prompt:promptFor(k), expected:expectedFor(k) }));
  qIndex = 0;
}

function renderQ(){
  const q = questions[qIndex];
  qProgress.textContent = `Question ${qIndex+1} / ${questions.length}`;
  promptText.textContent = q.prompt;
  answerInput.value = "";
  statusBox.classList.remove("good","bad");
  statusBox.textContent = "Type your answer to continue.";
  answerInput.focus();
}

function checkQ(){
  const q = questions[qIndex];
  const got = normalize(answerInput.value);
  const exp = normalize(q.expected);

  if (got === exp){
    statusBox.classList.add("good");
    statusBox.classList.remove("bad");
    statusBox.textContent = "Correct âœ“";
    qIndex++;
    if (qIndex >= questions.length) finishGame();
    else setTimeout(renderQ, 250);
  } else {
    statusBox.classList.add("bad");
    statusBox.classList.remove("good");
    statusBox.textContent = "Not quite â€” try again (use Ãª for Ãªtes).";
    answerInput.focus();
    answerInput.select();
  }
}

function startScenarios(){
  show(scenarioScreen);
  buildQuestions();
  renderQ();
}

/* LEADERBOARD */
let finalMs = null;

async function loadScores(){
  saveStatus.classList.remove("good","bad");
  saveStatus.textContent = "Loading leaderboardâ€¦";
  scoreTable.style.display = "none";
  scoreBody.innerHTML = "";
  try{
    const res = await fetch(HIGHSCORE_URL, { method:"GET" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const items = Array.isArray(data?.scores) ? data.scores : [];
    if (!items.length){
      saveStatus.textContent = "No scores yet. Be the first!";
      return;
    }
    scoreTable.style.display = "table";
    saveStatus.textContent = "Leaderboard loaded.";
    items.slice(0,10).forEach((s,i)=>{
      const tr = document.createElement("tr");
      const dt = s.date ? new Date(s.date) : null;
      const dateText = dt && !isNaN(dt) ? dt.toLocaleDateString() : "â€”";
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${escapeHtml(s.name || "â€”")}</td>
        <td><strong>${formatTime(Number(s.ms || 0))}</strong></td>
        <td>${escapeHtml(dateText)}</td>
      `;
      scoreBody.appendChild(tr);
    });
  }catch(e){
    saveStatus.classList.add("bad");
    saveStatus.textContent = "Couldnâ€™t load leaderboard (check Worker URL + CORS).";
  }
}

async function saveScore(){
  const name = (nameInput.value || "").trim() || "Anonymous";
  if (finalMs == null) return;

  saveBtn.disabled = true;
  saveStatus.classList.remove("good","bad");
  saveStatus.textContent = "Savingâ€¦";
  try{
    const res = await fetch(HIGHSCORE_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ name, ms: finalMs })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    saveStatus.classList.add("good");
    saveStatus.textContent = "Saved âœ“";
    await loadScores();
  }catch(e){
    saveBtn.disabled = false;
    saveStatus.classList.add("bad");
    saveStatus.textContent = "Save failed â€” check Worker secrets + Notion DB sharing.";
  }
}

function finishGame(){
  stopTimer();
  finalMs = elapsedMs();

  boardTitle.textContent = "Finished ðŸŽ‰";
  boardSubtitle.textContent = "Save your time and see the Top 10.";
  finalTimeText.innerHTML = `Your time: <strong>${formatTime(finalMs)}</strong>`;

  show(boardScreen);
  saveBtn.disabled = false;
  loadScores();
}

/* RESET */
function hardReset(){
  stopTimer();
  started = false;
  finalMs = null;
  timeText.textContent = "â€”";
  resetBtn.disabled = true;
  pronounList.innerHTML = "";
  conjList.innerHTML = "";
  statusBox.classList.remove("good","bad");
  statusBox.textContent = "Type your answer to continue.";
  nameInput.value = "";
  saveBtn.disabled = false;
  show(startScreen);
}

/* EVENTS */
apiLabel.textContent = HIGHSCORE_URL;
apiLabel2.textContent = HIGHSCORE_URL;

startBtn.addEventListener("click", ()=>{
  if (started) return;
  started = true;
  resetBtn.disabled = false;
  startTimer();
  show(matchScreen);
  buildMatchingUI();
});

resetBtn.addEventListener("click", hardReset);

viewBoardBtn.addEventListener("click", ()=>{
  boardTitle.textContent = "Leaderboard";
  boardSubtitle.textContent = "Top 10 fastest times.";
  finalTimeText.textContent = started ? `Current run time: ${timeText.textContent}` : "";
  show(boardScreen);
  loadScores();
});

backToStartBtn.addEventListener("click", ()=>show(startScreen));

playAgainBtn.addEventListener("click", ()=>{
  hardReset();
  started = true;
  resetBtn.disabled = false;
  startTimer();
  show(matchScreen);
  buildMatchingUI();
});

checkBtn.addEventListener("click", checkQ);

answerInput.addEventListener("keydown", (e)=>{
  if (e.key === "Enter"){ e.preventDefault(); checkQ(); }
  else if (e.key === "1"){ e.preventDefault(); insertAtCursor(answerInput, "Ãª"); }
});

key1.addEventListener("click", ()=>insertAtCursor(answerInput, "Ãª"));
saveBtn.addEventListener("click", saveScore);
</script>

</body>
</html>
