<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÃŠtre Speedrun â€“ Pronouns + Conjugations</title>
  <style>
    :root{
      --bg:#070b14;
      --panel: rgba(255,255,255,.08);
      --panel2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --text:#eef2ff;
      --muted:#a9b4d0;
      --good:#34d399;
      --bad:#fb7185;
      --accent:#60a5fa;
      --accent2:#c084fc;
      --shadow: 0 24px 80px rgba(0,0,0,.45);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(96,165,250,.22), transparent 60%),
        radial-gradient(900px 700px at 80% 30%, rgba(192,132,252,.18), transparent 55%),
        radial-gradient(700px 600px at 35% 85%, rgba(52,211,153,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    .topbar{
      position:fixed;
      top:14px; left:14px; right:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      z-index:10;
      pointer-events:none;
    }
    .pill{
      pointer-events:auto;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.28);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      font-weight:800;
      font-size:13px;
    }
    .pill span{color:var(--muted); font-weight:800}
    .pill strong{font-weight:900}
    .btn{
      pointer-events:auto;
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(180deg, rgba(96,165,250,.28), rgba(96,165,250,.12));
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      transition: transform .08s ease, filter .2s ease, opacity .2s ease;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:rgba(255,255,255,.08)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    .screen{
      height:100%;
      width:100%;
      display:none;
      align-items:center;
      justify-content:center;
      padding:84px 22px 22px;
    }
    .screen.active{display:flex}

    .card{
      width:min(980px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.14);
      border-radius:28px;
      box-shadow:var(--shadow);
      padding:22px;
    }

    h1{margin:0 0 8px; font-size:22px; letter-spacing:.2px}
    .sub{margin:0 0 18px; color:var(--muted); line-height:1.4}
    .row{display:flex; gap:14px; flex-wrap:wrap; align-items:center; justify-content:center}
    .spacer{height:14px}
    .divider{height:1px; background:rgba(255,255,255,.12); margin:16px 0}

    /* Matching */
    .matchWrap{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      width:100%;
      margin-top:10px;
    }
    .col{
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:20px;
      padding:14px;
      min-height:360px;
    }
    .colTitle{
      margin:0 0 10px;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      letter-spacing:.5px;
      text-transform:uppercase;
    }
    .list{display:flex; flex-direction:column; gap:10px}
    .tile{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .tile:hover{background:rgba(255,255,255,.08)}
    .tile:active{transform:translateY(1px)}
    .tile .chip{
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      white-space:nowrap;
    }
    .tile.selected{
      border-color:rgba(96,165,250,.75);
      background:rgba(96,165,250,.14);
    }
    .tile.locked{
      cursor:default;
      border-color:rgba(52,211,153,.55);
      background:rgba(52,211,153,.10);
    }
    .tile.bad{
      border-color:rgba(251,113,133,.7);
      background:rgba(251,113,133,.10);
    }
    .matchHint{color:var(--muted); font-size:13px; margin:0}

    /* Scenarios */
    .scenarioBox{
      width:min(720px, 100%);
      margin:0 auto;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:24px;
      padding:18px;
      text-align:center;
    }
    .qTop{display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-bottom:10px}
    .qPill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-weight:900;
      font-size:13px;
    }
    .prompt{
      font-size:22px;
      font-weight:1000;
      margin:8px 0 12px;
      letter-spacing:.2px;
    }
    .accentBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(255,255,255,.04);
      padding:10px;
      border-radius:16px;
      margin:10px 0 12px;
    }
    .accentHint{color:var(--muted); font-size:12px; font-weight:900}
    .keyBtn{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:999px;
      padding:7px 10px;
      cursor:pointer;
      font-weight:1000;
      font-size:12px;
    }
    .keyBtn kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:11px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      margin-right:6px;
    }
    .answerRow{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:stretch;
      flex-wrap:wrap;
      margin-top:10px;
    }
    input[type="text"]{
      width:min(520px, 100%);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:14px 14px;
      font-size:18px;
      font-weight:800;
      outline:none;
      text-align:center;
    }
    input[type="text"]:focus{
      border-color:rgba(96,165,250,.65);
      box-shadow:0 0 0 4px rgba(96,165,250,.18);
    }
    .status{
      margin-top:12px;
      font-weight:1000;
      border-radius:16px;
      padding:12px 14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:var(--muted);
    }
    .status.good{
      border-color:rgba(52,211,153,.55);
      background:rgba(52,211,153,.10);
      color:rgba(232,255,244,.92);
    }
    .status.bad{
      border-color:rgba(251,113,133,.6);
      background:rgba(251,113,133,.10);
      color:rgba(255,236,240,.92);
    }

    /* Leaderboard table */
    .scoresWrap{
      width:min(860px, 100%);
      margin:0 auto;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:24px;
      padding:18px;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.12);
      margin-top:10px;
    }
    th, td{
      text-align:left;
      padding:10px 10px;
      font-size:13px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    th{color:var(--muted); font-weight:1000; font-size:12px; text-transform:uppercase; letter-spacing:.4px}
    tr:last-child td{border-bottom:none}
    .fine{font-size:12px;color:var(--muted);line-height:1.35}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="pill"><span>Time</span> <strong id="timeText">â€”</strong></div>
    <div class="row" style="pointer-events:none">
      <button class="btn secondary" id="viewBoardBtn" style="pointer-events:auto">Leaderboard</button>
      <button class="btn secondary" id="resetBtn" style="pointer-events:auto" disabled>Reset</button>
    </div>
  </div>

  <!-- START -->
  <section class="screen active" id="startScreen">
    <div class="card">
      <h1>ÃŠtre Speedrun</h1>
      <p class="sub">
        Stage 1: match pronouns â†’ conjugations. Stage 2: 10 scenarios. Timer runs from Start to final correct answer.
      </p>
      <div class="row">
        <button class="btn" id="startBtn">Start</button>
      </div>
      <div class="divider"></div>
      <p class="fine">
        Leaderboard uses your Cloudflare Worker endpoint:
        <code id="apiLabel"></code>
      </p>
    </div>
  </section>

  <!-- MATCHING -->
  <section class="screen" id="matchScreen">
    <div class="card">
      <h1>Stage 1 â€” Matching</h1>
      <p class="sub">Click a pronoun, then click the matching conjugation. Duplicates like <strong>est</strong> and <strong>sont</strong> are handled correctly.</p>

      <div class="matchWrap">
        <div class="col">
          <p class="colTitle">Pronouns</p>
          <div class="list" id="pronounList"></div>
        </div>
        <div class="col">
          <p class="colTitle">Conjugations</p>
          <div class="list" id="conjList"></div>
        </div>
      </div>

      <div class="divider"></div>
      <p class="matchHint" id="matchStatus">Match all pairs to continue.</p>
    </div>
  </section>

  <!-- SCENARIOS -->
  <section class="screen" id="scenarioScreen">
    <div class="card">
      <h1>Stage 2 â€” Scenarios</h1>
      <p class="sub">Type the correct French answer. Case-insensitive. Spaces are flexible. Redos required until correct.</p>

      <div class="scenarioBox">
        <div class="qTop">
          <div class="qPill" id="qProgress">Question â€” / 10</div>
          <div class="qPill">Tip: press <strong>1</strong> for <strong>Ãª</strong></div>
        </div>

        <div class="prompt" id="promptText">â€”</div>

        <div class="accentBar">
          <div class="accentHint">Accent keys:</div>
          <button class="keyBtn" id="key1"><kbd>1</kbd> Ãª</button>
        </div>

        <div class="answerRow">
          <input id="answerInput" type="text" autocomplete="off" placeholder="Type (e.g., Il est)" />
          <button class="btn" id="checkBtn">Check</button>
        </div>

        <div class="status" id="statusBox">Type your answer to continue.</div>
      </div>
    </div>
  </section>

  <!-- FINISH + LEADERBOARD -->
  <section class="screen" id="boardScreen">
    <div class="card">
      <h1 id="boardTitle">Leaderboard</h1>
      <p class="sub" id="boardSubtitle">Top 10 fastest times.</p>

      <div class="scoresWrap">
        <div class="row" style="justify-content:space-between; align-items:flex-end">
          <div style="text-align:left">
            <div class="fine" id="finalTimeText"></div>
            <div class="fine">Save your score:</div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <input id="nameInput" type="text" maxlength="24" placeholder="Name" style="width:220px; text-align:left" />
            <button class="btn" id="saveBtn">Save</button>
          </div>
        </div>

        <div class="status" id="saveStatus" style="margin-top:12px">Loadingâ€¦</div>

        <table id="scoreTable" style="display:none">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Time</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="scoreBody"></tbody>
        </table>

        <div class="divider"></div>
        <div class="row">
          <button class="btn secondary" id="backToStartBtn">Back to Start</button>
          <button class="btn" id="playAgainBtn">Play Again</button>
        </div>

        <p class="fine" style="margin-top:12px">
          API: <code id="apiLabel2"></code>
        </p>
      </div>
    </div>
  </section>

<script>
/* ============================================================
   CONFIG: Your Cloudflare Worker endpoint
   ============================================================ */
const HIGHSCORE_URL = "https://pronounfrenchleaderboard.orcajoon.workers.dev/api/highscores";

/* ============================================================
   DATA
   ============================================================ */
// Matching pairs: each has a unique id, even if conjugation text duplicates.
const MATCH_PAIRS = [
  { id: "je",    pronoun: "Je",    conj: "suis"   },
  { id: "tu",    pronoun: "Tu",    conj: "es"     },
  { id: "il",    pronoun: "Il",    conj: "est"    },
  { id: "elle",  pronoun: "Elle",  conj: "est"    },
  { id: "on",    pronoun: "On",    conj: "est"    },
  { id: "nous",  pronoun: "Nous",  conj: "sommes" },
  { id: "vous",  pronoun: "Vous",  conj: "Ãªtes"   },
  { id: "ils",   pronoun: "Ils",   conj: "sont"   },
  { id: "elles", pronoun: "Elles", conj: "sont"   }
];

// Scenario blueprint: 10 questions, includes 2x "Ils sont"
const SCENARIO_KEYS = [
  "je",
  "tu",
  "il",
  "elle",
  "on",
  "nous",
  "vous",
  "ils",
  "ils",
  "elles"
];

const NAMES_MALE = ["Pierre","Louis","Hugo","Noah","Lucas","Arthur","Jules","Paul","Maxime","ThÃ©o","Antoine","Nicolas"];
const NAMES_FEMALE = ["Marie","Camille","ChloÃ©","Emma","LÃ©a","Sophie","Manon","Sarah","Julie","InÃ¨s","AnaÃ¯s","Clara"];
const NAMES_GROUP_MIXED = ["Pierre & Marie", "Louis & ChloÃ©", "Hugo & Emma", "Jules & LÃ©a", "Arthur & Sophie"];
const NAMES_GROUP_FEMALE = ["Marie & Camille", "ChloÃ© & LÃ©a", "Emma & Sarah", "Julie & Clara", "InÃ¨s & AnaÃ¯s"];

/* ============================================================
   DOM
   ============================================================ */
const timeText = document.getElementById("timeText");
const resetBtn = document.getElementById("resetBtn");
const startBtn = document.getElementById("startBtn");
const viewBoardBtn = document.getElementById("viewBoardBtn");

const startScreen = document.getElementById("startScreen");
const matchScreen = document.getElementById("matchScreen");
const scenarioScreen = document.getElementById("scenarioScreen");
const boardScreen = document.getElementById("boardScreen");

const pronounList = document.getElementById("pronounList");
const conjList = document.getElementById("conjList");
const matchStatus = document.getElementById("matchStatus");

const qProgress = document.getElementById("qProgress");
const promptText = document.getElementById("promptText");
const answerInput = document.getElementById("answerInput");
const checkBtn = document.getElementById("checkBtn");
const statusBox = document.getElementById("statusBox");
const key1 = document.getElementById("key1");

const apiLabel = document.getElementById("apiLabel");
const apiLabel2 = document.getElementById("apiLabel2");

const boardTitle = document.getElementById("boardTitle");
const boardSubtitle = document.getElementById("boardSubtitle");
const finalTimeText = document.getElementById("finalTimeText");
const nameInput = document.getElementById("nameInput");
const saveBtn = document.getElementById("saveBtn");
const saveStatus = document.getElementById("saveStatus");
const scoreTable = document.getElementById("scoreTable");
const scoreBody = document.getElementById("scoreBody");
const backToStartBtn = document.getElementById("backToStartBtn");
const playAgainBtn = document.getElementById("playAgainBtn");

/* ============================================================
   HELPERS
   ============================================================ */
function show(screen){
  [startScreen, matchScreen, scenarioScreen, boardScreen].forEach(s=>s.classList.remove("active"));
  screen.classList.add("active");
}

function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function formatTime(ms){
  const total = Math.max(0, Math.floor(ms));
  const sec = Math.floor(total/1000);
  const m = Math.floor(sec/60);
  const s = sec % 60;
  const cs = Math.floor((total % 1000)/10);
  return `${m}:${String(s).padStart(2,"0")}.${String(cs).padStart(2,"0")}`;
}

function normalize(s){
  return (s || "")
    .trim()
    .replace(/\s+/g, " ")
    .toLowerCase();
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}

function insertAtCursor(input, text){
  const start = input.selectionStart ?? input.value.length;
  const end = input.selectionEnd ?? input.value.length;
  const before = input.value.slice(0, start);
  const after  = input.value.slice(end);
  input.value = before + text + after;
  const pos = start + text.length;
  input.setSelectionRange(pos, pos);
  input.focus();
}

/* ============================================================
   TIMER
   ============================================================ */
let started = false;
let startMs = 0;
let timerHandle = null;

function startTimer(){
  startMs = performance.now();
  timeText.textContent = "0:00.00";
  timerHandle = setInterval(()=>{
    timeText.textContent = formatTime(performance.now() - startMs);
  }, 50);
}
function stopTimer(){
  if (timerHandle) clearInterval(timerHandle);
  timerHandle = null;
}
function totalElapsedMs(){
  return Math.floor(performance.now() - startMs);
}

/* ============================================================
   STAGE 1: MATCHING (pronoun -> conjugation), duplicates safe
   ============================================================ */
let selectedPronoun = null; // {id, el}
let selectedConj = null;    // {id, el}
let lockedPronounIds = new Set();
let lockedConjEls = new Set(); // lock by element to allow duplicate text
let lockedPronounEls = new Set();
let matchCount = 0;

function buildMatchingUI(){
  pronounList.innerHTML = "";
  conjList.innerHTML = "";

  selectedPronoun = null;
  selectedConj = null;
  lockedPronounIds.clear();
  lockedConjEls.clear();
  lockedPronounEls.clear();
  matchCount = 0;

  // Pronouns randomized
  const pronounItems = shuffle(MATCH_PAIRS.map(p => ({ id: p.id, text: p.pronoun })));
  // Conjugations randomized; duplicates are separate tiles
  const conjItems = shuffle(MATCH_PAIRS.map(p => ({ id: p.id, text: p.conj })));

  for (const item of pronounItems){
    const el = document.createElement("div");
    el.className = "tile";
    el.dataset.id = item.id;
    el.innerHTML = `<div>${item.text}</div><span class="chip">click</span>`;
    el.addEventListener("click", ()=>onPronounClick(el));
    pronounList.appendChild(el);
  }

  for (const item of conjItems){
    const el = document.createElement("div");
    el.className = "tile";
    el.dataset.id = item.id;
    el.innerHTML = `<div>${item.text}</div><span class="chip">click</span>`;
    el.addEventListener("click", ()=>onConjClick(el));
    conjList.appendChild(el);
  }

  matchStatus.textContent = "Match all pairs to continue.";
}

function clearTempBad(){
  document.querySelectorAll(".tile.bad").forEach(el=>el.classList.remove("bad"));
}

function onPronounClick(el){
  const id = el.dataset.id;
  if (lockedPronounIds.has(id) || lockedPronounEls.has(el)) return;

  clearTempBad();
  // deselect other pronouns
  document.querySelectorAll("#pronounList .tile.selected").forEach(t=>t.classList.remove("selected"));
  el.classList.add("selected");
  selectedPronoun = { id, el };
  tryResolveMatch();
}

function onConjClick(el){
  const id = el.dataset.id;
  if (lockedConjEls.has(el)) return;

  clearTempBad();
  // deselect other conjugations
  document.querySelectorAll("#conjList .tile.selected").forEach(t=>t.classList.remove("selected"));
  el.classList.add("selected");
  selectedConj = { id, el };
  tryResolveMatch();
}

function tryResolveMatch(){
  if (!selectedPronoun || !selectedConj) return;

  const correct = selectedPronoun.id === selectedConj.id;

  if (correct){
    // lock by pronoun id, and lock these specific elements
    lockedPronounIds.add(selectedPronoun.id);
    lockedPronounEls.add(selectedPronoun.el);
    lockedConjEls.add(selectedConj.el);

    selectedPronoun.el.classList.remove("selected");
    selectedConj.el.classList.remove("selected");
    selectedPronoun.el.classList.add("locked");
    selectedConj.el.classList.add("locked");
    selectedPronoun.el.querySelector(".chip").textContent = "âœ“";
    selectedConj.el.querySelector(".chip").textContent = "âœ“";

    selectedPronoun = null;
    selectedConj = null;

    matchCount++;
    matchStatus.textContent = `Matched ${matchCount} / ${MATCH_PAIRS.length}`;

    if (matchCount === MATCH_PAIRS.length){
      matchStatus.textContent = "Nice â€” moving to scenariosâ€¦";
      setTimeout(startScenarios, 350);
    }
  } else {
    // wrong: flash red
    selectedPronoun.el.classList.add("bad");
    selectedConj.el.classList.add("bad");
    selectedPronoun.el.classList.remove("selected");
    selectedConj.el.classList.remove("selected");

    const p = selectedPronoun;
    const c = selectedConj;
    selectedPronoun = null;
    selectedConj = null;

    setTimeout(()=>{
      p.el.classList.remove("bad");
      c.el.classList.remove("bad");
    }, 450);
  }
}

/* ============================================================
   STAGE 2: SCENARIOS
   ============================================================ */
let questions = [];
let qIndex = 0;

function expectedPhraseForKey(key){
  const p = MATCH_PAIRS.find(x => x.id === key);
  return `${p.pronoun} ${p.conj}`;
}

function makePromptForKey(key){
  // Make grammatically correct English prompts and disambiguate you-formality
  if (key === "je") return `I am â€¦`;
  if (key === "tu") return `You are (informal) â€¦`;
  if (key === "vous") return `You are (formal) â€¦`;
  if (key === "nous") return `We are â€¦`;
  if (key === "on") return `One is / People are â€¦`;
  if (key === "il") {
    const name = NAMES_MALE[Math.floor(Math.random()*NAMES_MALE.length)];
    return `${name} is â€¦`;
  }
  if (key === "elle") {
    const name = NAMES_FEMALE[Math.floor(Math.random()*NAMES_FEMALE.length)];
    return `${name} is â€¦`;
  }
  if (key === "ils") {
    const name = NAMES_GROUP_MIXED[Math.floor(Math.random()*NAMES_GROUP_MIXED.length)];
    return `${name} are â€¦`;
  }
  if (key === "elles") {
    const name = NAMES_GROUP_FEMALE[Math.floor(Math.random()*NAMES_GROUP_FEMALE.length)];
    return `${name} are â€¦`;
  }
  return `â€”`;
}

function buildScenarioQuestions(){
  const keys = shuffle(SCENARIO_KEYS);
  questions = keys.map(key => ({
    key,
    prompt: makePromptForKey(key),
    expected: expectedPhraseForKey(key)
  }));
  qIndex = 0;
}

function renderScenario(){
  const q = questions[qIndex];
  qProgress.textContent = `Question ${qIndex + 1} / ${questions.length}`;
  promptText.textContent = q.prompt;
  answerInput.value = "";
  statusBox.classList.remove("good","bad");
  statusBox.textContent = "Type your answer to continue.";
  answerInput.focus();
}

function checkScenario(){
  const q = questions[qIndex];
  const got = normalize(answerInput.value);
  const exp = normalize(q.expected);

  if (got === exp){
    statusBox.classList.remove("bad");
    statusBox.classList.add("good");
    statusBox.textContent = "Correct âœ“";
    qIndex++;
    if (qIndex >= questions.length){
      finishGame();
    } else {
      setTimeout(renderScenario, 250);
    }
  } else {
    statusBox.classList.remove("good");
    statusBox.classList.add("bad");
    statusBox.textContent = "Not quite â€” try again (use Ãª for Ãªtes).";
    answerInput.focus();
    answerInput.select();
  }
}

function startScenarios(){
  show(scenarioScreen);
  buildScenarioQuestions();
  renderScenario();
}

/* ============================================================
   FINISH + LEADERBOARD
   ============================================================ */
let finalMs = null;

async function loadScores(){
  saveStatus.classList.remove("good","bad");
  saveStatus.textContent = "Loading leaderboardâ€¦";
  scoreTable.style.display = "none";
  scoreBody.innerHTML = "";

  try{
    const res = await fetch(HIGHSCORE_URL, { method:"GET" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const items = Array.isArray(data?.scores) ? data.scores : [];

    if (!items.length){
      saveStatus.textContent = "No scores yet. Be the first!";
      return;
    }

    scoreTable.style.display = "table";
    saveStatus.textContent = "Leaderboard loaded.";
    items.slice(0,10).forEach((s, i)=>{
      const tr = document.createElement("tr");
      const dt = s.date ? new Date(s.date) : null;
      const dateText = dt && !isNaN(dt) ? dt.toLocaleDateString() : "â€”";
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${escapeHtml(s.name || "â€”")}</td>
        <td><strong>${formatTime(Number(s.ms || 0))}</strong></td>
        <td>${escapeHtml(dateText)}</td>
      `;
      scoreBody.appendChild(tr);
    });
  }catch(err){
    saveStatus.classList.add("bad");
    saveStatus.textContent = "Couldnâ€™t load leaderboard (check Worker URL + CORS).";
  }
}

async function saveScore(){
  const name = (nameInput.value || "").trim() || "Anonymous";
  if (finalMs == null) return;

  saveBtn.disabled = true;
  saveStatus.classList.remove("good","bad");
  saveStatus.textContent = "Savingâ€¦";

  try{
    const res = await fetch(HIGHSCORE_URL, {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ name, ms: finalMs })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    saveStatus.classList.add("good");
    saveStatus.textContent = "Saved âœ“";
    await loadScores();
  }catch(err){
    saveBtn.disabled = false;
    saveStatus.classList.add("bad");
    saveStatus.textContent = "Save failed â€” check Worker secrets + Notion DB sharing.";
  }
}

function finishGame(){
  stopTimer();
  finalMs = totalElapsedMs();

  boardTitle.textContent = "Finished ðŸŽ‰";
  boardSubtitle.textContent = "Save your time and see the Top 10.";
  finalTimeText.innerHTML = `Your time: <strong>${formatTime(finalMs)}</strong>`;

  show(boardScreen);
  saveBtn.disabled = false;
  loadScores();
}

/* ============================================================
   RESET
   ============================================================ */
function hardReset(){
  stopTimer();
  started = false;
  finalMs = null;
  timeText.textContent = "â€”";
  resetBtn.disabled = true;

  // clear UI states
  pronounList.innerHTML = "";
  conjList.innerHTML = "";
  matchStatus.textContent = "Match all pairs to continue.";

  statusBox.classList.remove("good","bad");
  statusBox.textContent = "Type your answer to continue.";

  nameInput.value = "";
  saveBtn.disabled = false;

  show(startScreen);
}

/* ============================================================
   EVENTS
   ============================================================ */
apiLabel.textContent = HIGHSCORE_URL;
apiLabel2.textContent = HIGHSCORE_URL;

startBtn.addEventListener("click", ()=>{
  if (started) return;
  started = true;
  resetBtn.disabled = false;

  startTimer();
  show(matchScreen);
  buildMatchingUI();
});

resetBtn.addEventListener("click", hardReset);

viewBoardBtn.addEventListener("click", ()=>{
  // View leaderboard any time (doesn't stop timer/game)
  boardTitle.textContent = "Leaderboard";
  boardSubtitle.textContent = "Top 10 fastest times.";
  finalTimeText.textContent = started ? `Current run time: ${timeText.textContent}` : "";
  show(boardScreen);
  loadScores();
});

backToStartBtn.addEventListener("click", ()=>{
  show(startScreen);
});

playAgainBtn.addEventListener("click", ()=>{
  hardReset();
  // auto-start a new run
  started = true;
  resetBtn.disabled = false;
  startTimer();
  show(matchScreen);
  buildMatchingUI();
});

checkBtn.addEventListener("click", checkScenario);

answerInput.addEventListener("keydown", (e)=>{
  if (e.key === "Enter"){
    e.preventDefault();
    checkScenario();
  } else if (e.key === "1"){
    e.preventDefault();
    insertAtCursor(answerInput, "Ãª");
  }
});

key1.addEventListener("click", ()=>insertAtCursor(answerInput, "Ãª"));

saveBtn.addEventListener("click", saveScore);
</script>

</body>
</html>
